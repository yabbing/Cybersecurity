// State Management
let currentMethodology = null;
let methodologies = [];
let progress = {};

// Initialize Application
document.addEventListener('DOMContentLoaded', () => {
    initializeApp();
    setupEventListeners();
});

function initializeApp() {
    // Load theme preference
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);

    // Load methodologies
    loadMethodologies();

    // Load progress
    loadProgress();

    // Render UI
    renderMethodologyNav();
    updateProgressSummary();
}

function setupEventListeners() {
    // Theme toggle
    document.getElementById('themeToggle').addEventListener('click', toggleTheme);

    // Upload button
    document.getElementById('uploadBtn').addEventListener('click', () => {
        document.getElementById('uploadModal').classList.add('active');
    });

    // Close modal
    document.getElementById('closeModal').addEventListener('click', () => {
        document.getElementById('uploadModal').classList.remove('active');
    });

    // Click outside modal to close
    document.getElementById('uploadModal').addEventListener('click', (e) => {
        if (e.target.id === 'uploadModal') {
            document.getElementById('uploadModal').classList.remove('active');
        }
    });

    // File upload
    const fileUploadArea = document.getElementById('fileUploadArea');
    const fileInput = document.getElementById('fileInput');

    fileUploadArea.addEventListener('click', () => fileInput.click());

    fileUploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        fileUploadArea.style.borderColor = 'var(--accent-primary)';
    });

    fileUploadArea.addEventListener('dragleave', () => {
        fileUploadArea.style.borderColor = 'var(--border-color)';
    });

    fileUploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        fileUploadArea.style.borderColor = 'var(--border-color)';
        const file = e.dataTransfer.files[0];
        if (file) handleFileUpload(file);
    });

    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) handleFileUpload(file);
    });

    // Reset progress
    document.getElementById('resetProgressBtn').addEventListener('click', resetProgress);

    // Export progress
    document.getElementById('exportProgressBtn').addEventListener('click', exportProgress);
}

function toggleTheme() {
    const currentTheme = document.documentElement.getAttribute('data-theme');
    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
    document.documentElement.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
}

function loadMethodologies() {
    const savedMethodologies = localStorage.getItem('methodologies');
    if (savedMethodologies) {
        methodologies = JSON.parse(savedMethodologies);
    } else {
        methodologies = defaultMethodologies;
        saveMethodologies();
    }
}

function saveMethodologies() {
    localStorage.setItem('methodologies', JSON.stringify(methodologies));
}

function loadProgress() {
    const savedProgress = localStorage.getItem('progress');
    if (savedProgress) {
        progress = JSON.parse(savedProgress);
    }
}

function saveProgress() {
    localStorage.setItem('progress', JSON.stringify(progress));
}

function renderMethodologyNav() {
    const nav = document.getElementById('methodologyNav');
    nav.innerHTML = '';

    methodologies.forEach(methodology => {
        const item = document.createElement('div');
        item.className = 'methodology-item';
        item.dataset.id = methodology.id;

        const completed = getCompletedCount(methodology.id);
        const total = methodology.items.length;
        const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;

        item.innerHTML = `
            <div class="methodology-name">${methodology.name}</div>
            <div class="methodology-desc">${methodology.description}</div>
            <div class="methodology-progress">${completed}/${total} (${percentage}%)</div>
        `;

        item.addEventListener('click', () => selectMethodology(methodology.id));
        nav.appendChild(item);
    });
}

function selectMethodology(id) {
    currentMethodology = methodologies.find(m => m.id === id);

    // Update active state
    document.querySelectorAll('.methodology-item').forEach(item => {
        item.classList.remove('active');
        if (item.dataset.id === id) {
            item.classList.add('active');
        }
    });

    // Render checklist
    renderChecklist();
    renderHints();

    // Update title
    document.getElementById('currentMethodologyTitle').textContent = currentMethodology.name;
}

function renderChecklist() {
    if (!currentMethodology) return;

    const container = document.getElementById('checklistContainer');
    container.innerHTML = '';

    // Group items by category
    const categories = {};
    currentMethodology.items.forEach(item => {
        if (!categories[item.category]) {
            categories[item.category] = [];
        }
        categories[item.category].push(item);
    });

    // Render each category
    Object.keys(categories).forEach(category => {
        const categoryDiv = document.createElement('div');
        categoryDiv.className = 'checklist-category';

        const header = document.createElement('div');
        header.className = 'category-header';
        header.textContent = category;
        categoryDiv.appendChild(header);

        const itemsDiv = document.createElement('div');
        itemsDiv.className = 'checklist-items';

        categories[category].forEach(item => {
            const itemDiv = createChecklistItem(item);
            itemsDiv.appendChild(itemDiv);
        });

        categoryDiv.appendChild(itemsDiv);
        container.appendChild(categoryDiv);
    });
}

function createChecklistItem(item) {
    const div = document.createElement('div');
    div.className = 'checklist-item';

    const isCompleted = isItemCompleted(currentMethodology.id, item.id);
    if (isCompleted) {
        div.classList.add('completed');
    }

    div.innerHTML = `
        <div class="checkbox-wrapper">
            <input type="checkbox" class="checkbox-input" ${isCompleted ? 'checked' : ''} data-item-id="${item.id}">
            <div class="checkbox-custom"></div>
        </div>
        <div class="item-text">${item.text}</div>
    `;

    const checkbox = div.querySelector('.checkbox-input');
    checkbox.addEventListener('change', () => toggleItemCompletion(currentMethodology.id, item.id));

    return div;
}

function renderHints() {
    if (!currentMethodology) return;

    const hintsContent = document.getElementById('hintsContent');
    hintsContent.innerHTML = '';

    currentMethodology.hints.forEach(hint => {
        const hintDiv = document.createElement('div');
        hintDiv.className = 'hint-item';
        hintDiv.textContent = hint;
        hintsContent.appendChild(hintDiv);
    });
}

function isItemCompleted(methodologyId, itemId) {
    if (!progress[methodologyId]) return false;
    return progress[methodologyId].includes(itemId);
}

function toggleItemCompletion(methodologyId, itemId) {
    if (!progress[methodologyId]) {
        progress[methodologyId] = [];
    }

    const index = progress[methodologyId].indexOf(itemId);
    if (index > -1) {
        progress[methodologyId].splice(index, 1);
    } else {
        progress[methodologyId].push(itemId);
    }

    saveProgress();
    renderMethodologyNav();
    updateProgressSummary();

    // Update the item's visual state
    const item = document.querySelector(`[data-item-id="${itemId}"]`).closest('.checklist-item');
    item.classList.toggle('completed');
}

function getCompletedCount(methodologyId) {
    if (!progress[methodologyId]) return 0;
    return progress[methodologyId].length;
}

function updateProgressSummary() {
    const summary = document.getElementById('progressSummary');

    let totalItems = 0;
    let totalCompleted = 0;

    methodologies.forEach(methodology => {
        totalItems += methodology.items.length;
        totalCompleted += getCompletedCount(methodology.id);
    });

    const percentage = totalItems > 0 ? Math.round((totalCompleted / totalItems) * 100) : 0;

    summary.innerHTML = `
        <h3>Overall Progress</h3>
        <div class="stat-item">
            <span class="stat-label">Total Tasks</span>
            <span class="stat-value">${totalItems}</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Completed</span>
            <span class="stat-value">${totalCompleted}</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Remaining</span>
            <span class="stat-value">${totalItems - totalCompleted}</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Progress</span>
            <span class="stat-value">${percentage}%</span>
        </div>
    `;
}

function handleFileUpload(file) {
    if (!file.name.endsWith('.json')) {
        alert('Please upload a JSON file');
        return;
    }

    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const data = JSON.parse(e.target.result);

            // Validate structure
            if (!data.name || !data.items || !Array.isArray(data.items)) {
                alert('Invalid JSON structure. Please check the format.');
                return;
            }

            // Generate unique ID
            const id = 'custom-' + Date.now();

            const newMethodology = {
                id: id,
                name: data.name,
                description: data.description || 'Custom methodology',
                items: data.items.map((item, index) => ({
                    id: `${id}-${index}`,
                    text: item.text,
                    category: item.category || 'General'
                })),
                hints: data.hints || []
            };

            methodologies.push(newMethodology);
            saveMethodologies();
            renderMethodologyNav();

            // Close modal
            document.getElementById('uploadModal').classList.remove('active');
            document.getElementById('fileInput').value = '';

            alert('Custom methodology uploaded successfully!');
        } catch (error) {
            alert('Error parsing JSON file: ' + error.message);
        }
    };

    reader.readAsText(file);
}

function resetProgress() {
    if (!currentMethodology) {
        alert('Please select a methodology first');
        return;
    }

    if (confirm(`Reset all progress for ${currentMethodology.name}?`)) {
        delete progress[currentMethodology.id];
        saveProgress();
        renderChecklist();
        renderMethodologyNav();
        updateProgressSummary();
    }
}

function exportProgress() {
    const exportData = {
        timestamp: new Date().toISOString(),
        methodologies: methodologies,
        progress: progress
    };

    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `pentest-progress-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
}
